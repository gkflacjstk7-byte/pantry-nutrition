import React, { useEffect, useMemo, useState } from "react";

/**
 * 냉장고 식재료/영양 관리 (모바일 우선)
 * - 재고 등록(이름, 수량, 단위, 100g(ml)당 영양성분)
 * - 사용 시 수량 차감(로그 기록)
 * - 1회 섭취량(그램/개) 입력 시 즉시 칼로리/탄단지 계산
 * - 일일 섭취 로그와 합계(칼로리/탄수/단백/지방) 집계
 * - 로컬스토리지 영구 저장, JSON 내보내기/가져오기
 * - 반응형 UI (모바일 최적화), 다크모드 지원
 *
 * 주의: 외부 영양 DB 연동 없이, 품목별 100g(ml) 기준 수치를 사용자가 입력/수정하도록 설계
 */

// 기본 단위 옵션
const UNIT_OPTIONS = ["g", "ml", "개"] as const;

// 품목 타입
interface Item {
  id: string;
  name: string;
  qty: number; // 보유 수량
  unit: typeof UNIT_OPTIONS[number];
  kcalPer100: number; // 100g(or ml) 또는 1개 기준 칼로리 (unit이 개일 때는 per1)
  cPer100: number; // 탄수화물 g
  pPer100: number; // 단백질 g
  fPer100: number; // 지방 g
  perIsPiece?: boolean; // true면 위 값들이 "1개 기준"임
}

// 사용 로그 타입
interface UseLog {
  id: string;
  itemId: string;
  name: string;
  amount: number; // 사용 수량
  unit: typeof UNIT_OPTIONS[number];
  dt: string; // ISO
  // 해당 사용분의 영양 합계
  kcal: number;
  c: number;
  p: number;
  f: number;
}

// 로컬 스토리지 키
const LS_ITEMS = "pantry_items_v1";
const LS_LOGS = "pantry_logs_v1";

// 유틸
const uid = () => Math.random().toString(36).slice(2, 10);
const fmt = (n: number) => (isNaN(n) ? "-" : n.toFixed(1));

// 사용자의 재고 초기값 (요청에 제공된 목록 반영; 영양값은 일부만 예시로 넣고 나머지는 0으로 두어 사용자가 편집)
const initialItems: Item[] = [
  { id: uid(), name: "굽네몰 언더299 도시락", qty: 8, unit: "개", kcalPer100: 285, cPer100: 40, pPer100: 18, fPer100: 6, perIsPiece: true },
  { id: uid(), name: "매일바이오 무가당 그릭요거트", qty: 400, unit: "g", kcalPer100: 90, cPer100: 5, pPer100: 7, fPer100: 4.8 },
  { id: uid(), name: "방울토마토", qty: 500, unit: "g", kcalPer100: 18, cPer100: 3.9, pPer100: 0.9, fPer100: 0.2 },
  { id: uid(), name: "모짜렐라 피자치즈", qty: 200, unit: "g", kcalPer100: 254, cPer100: 2.8, pPer100: 24.3, fPer100: 15.9 },
  { id: uid(), name: "애호박", qty: 250, unit: "g", kcalPer100: 20, cPer100: 3.5, pPer100: 1.6, fPer100: 0.2 },
  { id: uid(), name: "맑은콩 순두부", qty: 400, unit: "g", kcalPer100: 55, cPer100: 2.9, pPer100: 4.8, fPer100: 2.7 },
  { id: uid(), name: "저지방 우유", qty: 900, unit: "ml", kcalPer100: 45, cPer100: 4.8, pPer100: 3.4, fPer100: 1.5 },
  { id: uid(), name: "논알콜 칭따오", qty: 8, unit: "개", kcalPer100: 60, cPer100: 14, pPer100: 0, fPer100: 0, perIsPiece: true },
  { id: uid(), name: "비요뜨 초코링", qty: 3, unit: "개", kcalPer100: 198, cPer100: 26, pPer100: 5, fPer100: 7, perIsPiece: true },
  { id: uid(), name: "요구르트 이오", qty: 10, unit: "개", kcalPer100: 50, cPer100: 11, pPer100: 1, fPer100: 0, perIsPiece: true },
  { id: uid(), name: "바나나", qty: 650, unit: "g", kcalPer100: 89, cPer100: 22.8, pPer100: 1.1, fPer100: 0.3 },
  { id: uid(), name: "플라이밀 마녀스프 마라치킨", qty: 5, unit: "개", kcalPer100: 150, cPer100: 15, pPer100: 10, fPer100: 5, perIsPiece: true },
  { id: uid(), name: "냉동 오징어 링채", qty: 200, unit: "g", kcalPer100: 92, cPer100: 3.1, pPer100: 15.6, fPer100: 1.4 },
  { id: uid(), name: "곰곰 맷돌두부", qty: 300, unit: "g", kcalPer100: 125, cPer100: 7.9, pPer100: 11, fPer100: 5.3 },
  { id: uid(), name: "염장 미역줄기", qty: 1000, unit: "g", kcalPer100: 18, cPer100: 3, pPer100: 1, fPer100: 0.2 },
  { id: uid(), name: "곰곰 흰다리 새우", qty: 200, unit: "g", kcalPer100: 106, cPer100: 0.9, pPer100: 20.3, fPer100: 1.7 },
  { id: uid(), name: "맥반석 구운란", qty: 30, unit: "개", kcalPer100: 73, cPer100: 0.6, pPer100: 6.3, fPer100: 5, perIsPiece: true },
  { id: uid(), name: "풀무원 지구식단 메밀두유면", qty: 2, unit: "개", kcalPer100: 80, cPer100: 16, pPer100: 3.5, fPer100: 1.5, perIsPiece: true },
  { id: uid(), name: "풀무원 지구식단 남작두유면", qty: 2, unit: "개", kcalPer100: 80, cPer100: 16, pPer100: 3.5, fPer100: 1.5, perIsPiece: true },
  { id: uid(), name: "풀무원 지구식단 얇은 두유면", qty: 3, unit: "개", kcalPer100: 80, cPer100: 16, pPer100: 3.5, fPer100: 1.5, perIsPiece: true },
  { id: uid(), name: "저당 짜장소스", qty: 300, unit: "g", kcalPer100: 90, cPer100: 15, pPer100: 3, fPer100: 2 },
  { id: uid(), name: "숙주나물", qty: 300, unit: "g", kcalPer100: 31, cPer100: 6, pPer100: 3, fPer100: 0.2 },
  { id: uid(), name: "치킨스톡 튜브", qty: 270, unit: "g", kcalPer100: 250, cPer100: 10, pPer100: 15, fPer100: 15 },
  { id: uid(), name: "청경채", qty: 150, unit: "g", kcalPer100: 13, cPer100: 2, pPer100: 1.1, fPer100: 0.1 },
  { id: uid(), name: "팽이버섯", qty: 300, unit: "g", kcalPer100: 42, cPer100: 7, pPer100: 2.7, fPer100: 0.4 },
  { id: uid(), name: "양배추", qty: 1000, unit: "g", kcalPer100: 20, cPer100: 3.5, pPer100: 1, fPer100: 0.2 },
  { id: uid(), name: "닭가슴살(다향)", qty: 600, unit: "g", kcalPer100: 165, cPer100: 0, pPer100: 31, fPer100: 3.6 },
  { id: uid(), name: "우삼겹 대패", qty: 1000, unit: "g", kcalPer100: 214, cPer100: 0, pPer100: 21.4, fPer100: 14.2 },
  { id: uid(), name: "올리브유", qty: 100, unit: "g", kcalPer100: 884, cPer100: 0, pPer100: 0, fPer100: 100 },
].map((x, i) => ({ ...x, id: `it_${i}_${x.name}` }));

function loadItems(): Item[] {
  try {
    const raw = localStorage.getItem(LS_ITEMS);
    if (raw) return JSON.parse(raw);
  } catch {}
  return initialItems;
}

function loadLogs(): UseLog[] {
  try {
    const raw = localStorage.getItem(LS_LOGS);
    if (raw) return JSON.parse(raw);
  } catch {}
  return [];
}

function saveItems(items: Item[]) {
  localStorage.setItem(LS_ITEMS, JSON.stringify(items));
}
function saveLogs(logs: UseLog[]) {
  localStorage.setItem(LS_LOGS, JSON.stringify(logs));
}

function App() {
  const [items, setItems] = useState<Item[]>(loadItems);
  const [logs, setLogs] = useState<UseLog[]>(loadLogs);
  const [q, setQ] = useState("");
  const [dark, setDark] = useState(true);

  useEffect(() => saveItems(items), [items]);
  useEffect(() => saveLogs(logs), [logs]);
  useEffect(() => {
    document.documentElement.classList.toggle("dark", dark);
  }, [dark]);

  const filtered = useMemo(() => {
    const s = q.trim().toLowerCase();
    if (!s) return items;
    return items.filter((it) => it.name.toLowerCase().includes(s));
  }, [items, q]);

  // 아이템 추가/수정 모달 제어
  const [editOpen, setEditOpen] = useState(false);
  const [editItem, setEditItem] = useState<Item | null>(null);

  function openNew() {
    setEditItem({
      id: uid(),
      name: "",
      qty: 0,
      unit: "g",
      kcalPer100: 0,
      cPer100: 0,
      pPer100: 0,
      fPer100: 0,
    });
    setEditOpen(true);
  }
  function openEdit(it: Item) {
    setEditItem({ ...it });
    setEditOpen(true);
  }
  function saveEdit() {
    if (!editItem) return;
    setItems((prev) => {
      const exist = prev.findIndex((p) => p.id === editItem.id);
      if (exist >= 0) {
        const copy = [...prev];
        copy[exist] = editItem;
        return copy;
      }
      return [editItem, ...prev];
    });
    setEditOpen(false);
  }

  function removeItem(id: string) {
    if (!confirm("이 품목을 삭제할까요? (로그는 보존됨)")) return;
    setItems((prev) => prev.filter((x) => x.id !== id));
  }

  // 사용(차감)
  const [useAmt, setUseAmt] = useState<Record<string, number>>({});

  function calcMacro(it: Item, amount: number) {
    // per 기준 계산
    const per = it.perIsPiece ? 1 : 100; // 1개 기준 vs 100g/ml 기준
    const ratio = it.perIsPiece ? amount : amount / per;
    const kcal = it.kcalPer100 * ratio;
    const c = it.cPer100 * ratio;
    const p = it.pPer100 * ratio;
    const f = it.fPer100 * ratio;
    return { kcal, c, p, f };
  }

  function useItem(it: Item) {
    const amt = Number(useAmt[it.id] || 0);
    if (!amt || amt <= 0) return alert("사용 수량을 입력하세요");
    if (!it.perIsPiece && it.unit !== "개" && amt > it.qty) {
      if (!confirm("재고보다 많이 사용합니다. 0 이하가 될 수 있어요. 계속할까요?")) return;
    }

    // 재고 차감
    setItems((prev) => prev.map((p) => (p.id === it.id ? { ...p, qty: p.qty - amt } : p)));
    const m = calcMacro(it, amt);
    const log: UseLog = {
      id: uid(),
      itemId: it.id,
      name: it.name,
      amount: amt,
      unit: it.unit,
      dt: new Date().toISOString(),
      ...m,
    };
    setLogs((prev) => [log, ...prev]);
    setUseAmt((s) => ({ ...s, [it.id]: 0 }));
  }

  // 오늘 로그 집계
  const todayKey = new Date().toISOString().slice(0, 10);
  const todayLogs = logs.filter((l) => l.dt.slice(0, 10) === todayKey);
  const totals = todayLogs.reduce(
    (acc, l) => {
      acc.kcal += l.kcal;
      acc.c += l.c;
      acc.p += l.p;
      acc.f += l.f;
      return acc;
    },
    { kcal: 0, c: 0, p: 0, f: 0 }
  );

  // 내보내기/가져오기
  function exportAll() {
    const blob = new Blob([JSON.stringify({ items, logs }, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `pantry_${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function importAll(evt: React.ChangeEvent<HTMLInputElement>) {
    const file = evt.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(String(reader.result));
        if (data.items && data.logs) {
          setItems(data.items);
          setLogs(data.logs);
        } else if (data.items) {
          setItems(data.items);
        }
      } catch (e) {
        alert("불러오기 실패: JSON 형식 확인");
      }
    };
    reader.readAsText(file);
    evt.target.value = "";
  }

  return (
    <div className="min-h-dvh bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100">
      <header className="sticky top-0 z-10 backdrop-blur border-b border-gray-200/60 dark:border-gray-800/60 bg-white/70 dark:bg-gray-950/70">
        <div className="max-w-3xl mx-auto px-4 py-3 flex items-center gap-2">
          <h1 className="text-lg font-semibold">냉장고 식재료·영양 관리</h1>
          <div className="ml-auto flex items-center gap-2">
            <input
              value={q}
              onChange={(e) => setQ(e.target.value)}
              placeholder="품목 검색"
              className="px-3 py-1.5 rounded-xl bg-gray-100 dark:bg-gray-900 text-sm outline-none w-40"
            />
            <button onClick={() => setDark((d) => !d)} className="px-3 py-1.5 rounded-xl text-sm border border-gray-300 dark:border-gray-700">
              {dark ? "라이트" : "다크"}
            </button>
            <button onClick={openNew} className="px-3 py-1.5 rounded-xl text-sm bg-blue-600 text-white">추가</button>
            <button onClick={exportAll} className="px-3 py-1.5 rounded-xl text-sm border">내보내기</button>
            <label className="px-3 py-1.5 rounded-xl text-sm border cursor-pointer">
              불러오기
              <input type="file" accept="application/json" className="hidden" onChange={importAll} />
            </label>
          </div>
        </div>
      </header>

      <main className="max-w-3xl mx-auto px-4 py-4">
        {/* 오늘 합계 */}
        <section className="mb-4 grid grid-cols-4 gap-2">
          <div className="p-3 rounded-xl bg-gray-100 dark:bg-gray-900">
            <div className="text-xs text-gray-500">칼로리</div>
            <div className="text-lg font-semibold">{fmt(totals.kcal)} kcal</div>
          </div>
          <div className="p-3 rounded-xl bg-gray-100 dark:bg-gray-900">
            <div className="text-xs text-gray-500">탄수</div>
            <div className="text-lg font-semibold">{fmt(totals.c)} g</div>
          </div>
          <div className="p-3 rounded-xl bg-gray-100 dark:bg-gray-900">
            <div className="text-xs text-gray-500">단백</div>
            <div className="text-lg font-semibold">{fmt(totals.p)} g</div>
          </div>
          <div className="p-3 rounded-xl bg-gray-100 dark:bg-gray-900">
            <div className="text-xs text-gray-500">지방</div>
            <div className="text-lg font-semibold">{fmt(totals.f)} g</div>
          </div>
        </section>

        {/* 품목 리스트 */}
        <section className="space-y-2">
          {filtered.map((it) => {
            const amt = Number(useAmt[it.id] || 0);
            const macros = calcMacro(it, amt);
            return (
              <div key={it.id} className="rounded-2xl border border-gray-200 dark:border-gray-800 p-3">
                <div className="flex items-start gap-2">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 flex-wrap">
                      <div className="font-semibold">{it.name}</div>
                      <span className="text-xs px-2 py-0.5 rounded-full bg-gray-100 dark:bg-gray-900 border border-gray-200 dark:border-gray-800">
                        재고: {fmt(it.qty)} {it.unit}
                      </span>
                      {it.perIsPiece && (
                        <span className="text-xs text-gray-500">(1개 기준 영양)</span>
                      )}
                    </div>
                    <div className="mt-1 text-xs text-gray-600 dark:text-gray-400">
                      100{it.perIsPiece ? (it.unit === "개" ? "%" : "?") : it.unit} 기준: {fmt(it.kcalPer100)}kcal · C {fmt(it.cPer100)}g · P {fmt(it.pPer100)}g · F {fmt(it.fPer100)}g
                    </div>
                  </div>
                  <div className="flex gap-1">
                    <button onClick={() => openEdit(it)} className="px-3 py-1.5 rounded-xl text-sm border">편집</button>
                    <button onClick={() => removeItem(it.id)} className="px-3 py-1.5 rounded-xl text-sm border">삭제</button>
                  </div>
                </div>
                <div className="mt-3 flex items-center gap-2">
                  <input
                    type="number"
                    min={0}
                    step={it.unit === "개" || it.perIsPiece ? 1 : 5}
                    value={useAmt[it.id] || ""}
                    onChange={(e) => setUseAmt((s) => ({ ...s, [it.id]: Number(e.target.value) }))}
                    className="w-28 px-3 py-2 rounded-xl bg-gray-100 dark:bg-gray-900 outline-none"
                    placeholder={`사용량 (${it.unit})`}
                  />
                  <button onClick={() => useItem(it)} className="px-3 py-2 rounded-xl bg-emerald-600 text-white">차감</button>
                  {amt > 0 && (
                    <div className="text-xs text-gray-600 dark:text-gray-400">
                      사용분: {amt}
                      {it.unit} → {fmt(macros.kcal)}kcal, C {fmt(macros.c)}g, P {fmt(macros.p)}g, F {fmt(macros.f)}g
                    </div>
                  )}
                </div>
              </div>
            );
          })}
        </section>

        {/* 오늘 사용 로그 */}
        <section className="mt-8">
          <div className="flex items-center justify-between mb-2">
            <h2 className="font-semibold">오늘 사용 로그</h2>
            <button
              onClick={() =>
                setLogs((prev) => prev.filter((l) => l.dt.slice(0, 10) !== todayKey))
              }
              className="text-sm border px-3 py-1.5 rounded-xl"
            >
              오늘 로그 삭제
            </button>
          </div>
          {todayLogs.length === 0 ? (
            <div className="text-sm text-gray-500">오늘 기록이 없습니다.</div>
          ) : (
            <div className="space-y-2">
              {todayLogs.map((l) => (
                <div key={l.id} className="border border-gray-200 dark:border-gray-800 rounded-xl p-2 text-sm">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="font-medium">{l.name}</div>
                      <div className="text-gray-500">
                        {new Date(l.dt).toLocaleTimeString()} · {l.amount}
                        {l.unit}
                      </div>
                    </div>
                    <div className="text-right text-xs">
                      <div>{fmt(l.kcal)} kcal</div>
                      <div>C {fmt(l.c)} · P {fmt(l.p)} · F {fmt(l.f)}</div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </section>
      </main>

      {/* 편집 모달 */}
      {editOpen && editItem && (
        <div className="fixed inset-0 bg-black/40 flex items-center justify-center p-4" onClick={() => setEditOpen(false)}>
          <div className="w-full max-w-md rounded-2xl bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 p-4" onClick={(e) => e.stopPropagation()}>
            <h3 className="font-semibold mb-3">품목 {editItem.id.startsWith("it_") ? "편집" : "추가"}</h3>
            <div className="grid grid-cols-2 gap-2">
              <label className="col-span-2 text-sm">이름
                <input className="w-full px-3 py-2 rounded-xl bg-gray-100 dark:bg-gray-900 mt-1" value={editItem.name} onChange={(e) => setEditItem({ ...editItem, name: e.target.value })} />
              </label>
              <label className="text-sm">수량
                <input type="number" className="w-full px-3 py-2 rounded-xl bg-gray-100 dark:bg-gray-900 mt-1" value={editItem.qty} onChange={(e) => setEditItem({ ...editItem, qty: Number(e.target.value) })} />
              </label>
              <label className="text-sm">단위
                <select className="w-full px-3 py-2 rounded-xl bg-gray-100 dark:bg-gray-900 mt-1" value={editItem.unit} onChange={(e) => setEditItem({ ...editItem, unit: e.target.value as Item["unit"] })}>
                  {UNIT_OPTIONS.map((u) => (
                    <option key={u} value={u}>{u}</option>
                  ))}
                </select>
              </label>
              <label className="col-span-2 text-sm flex items-center gap-2">
                <input type="checkbox" checked={!!editItem.perIsPiece} onChange={(e) => setEditItem({ ...editItem, perIsPiece: e.target.checked })} />
                100g/ml 기준이 아니라 "1개 기준 영양"을 사용
              </label>
              <label className="text-sm">kcal/100
                <input type="number" className="w-full px-3 py-2 rounded-xl bg-gray-100 dark:bg-gray-900 mt-1" value={editItem.kcalPer100} onChange={(e) => setEditItem({ ...editItem, kcalPer100: Number(e.target.value) })} />
              </label>
              <label className="text-sm">탄수/100(g)
                <input type="number" className="w-full px-3 py-2 rounded-xl bg-gray-100 dark:bg-gray-900 mt-1" value={editItem.cPer100} onChange={(e) => setEditItem({ ...editItem, cPer100: Number(e.target.value) })} />
              </label>
              <label className="text-sm">단백/100(g)
                <input type="number" className="w-full px-3 py-2 rounded-xl bg-gray-100 dark:bg-gray-900 mt-1" value={editItem.pPer100} onChange={(e) => setEditItem({ ...editItem, pPer100: Number(e.target.value) })} />
              </label>
              <label className="text-sm">지방/100(g)
                <input type="number" className="w-full px-3 py-2 rounded-xl bg-gray-100 dark:bg-gray-900 mt-1" value={editItem.fPer100} onChange={(e) => setEditItem({ ...editItem, fPer100: Number(e.target.value) })} />
              </label>
            </div>
            <div className="mt-4 flex justify-end gap-2">
              <button className="px-3 py-2 rounded-xl border" onClick={() => setEditOpen(false)}>취소</button>
              <button className="px-3 py-2 rounded-xl bg-blue-600 text-white" onClick={saveEdit}>저장</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

export default App;
